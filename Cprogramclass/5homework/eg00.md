# 第6章 指针 and 引用

C语言中， **指针** 对描述 数据实体之间的关系 的作用至关重要  
指针 的内部实现就是 程序对象 在计算机内存中的 **存储地址**  
是否可以充分利用 指针 编写程序对能否充分发挥计算机性能十分重要  

C语言中，给予了指针一定的计算能力，使其可以顺序变化地指向 数组的各个元素  
并且可以为函数设置 **指针类型的形参** 和 *函数指针形参(?)*  

传统高级语言中， **引用** 是函数的 形参 and 实参 结合的方式之一  
C++则是将引用看作数据对象的一种标志，不仅可用于说明 形参 and 实参 的结合方式，还可用于标志数据对象  

## 6.1 指针的基本概念

指针的主要作用：  

1. 间接引用所指对象  
2. 描述数据之间关系，在数据结构上应用很重要  
3. 利用指针形参，允许函数间接引用调用环境中的变量  
4. 指针 and 数组 结合，更灵活的访问数组元素  

### 1. 变量 变量的地址 and 变量的值

变量定义-\>变量的 类型 and 标识符  
变量的类型 供编译系统参考，以确定其所需内存块字节数量 and 值的表示形式 and 检查变量操作的合法性 and 翻译合法操作为计算机指令  
变量名 供程序引用变量的 **值** or **地址**  
变量值和地址：变量在内存中占据若干子节组成的一个内存储块，存放变量的值，其开始地址即变量地址  
如下例  

```c
int x = 1 ;
x = x + 2 ;
```

```x = x + 2 ;```语句中  
左边的x 表示值的存储位置  
右边的x 表示引用 变量x的值  
拆分一下就是：取x值，加上2，将结果存入x  

### 2. 指针变量 and 其所指向的变量

C语言中  
取地址运算：通过取地址运算符'\&'获取变量地址  
变量的地址：本身也是一种数据，可进行 存储 and 运算  
指针变量：存储程序对象地址值的变量  
指针变量的种类：针对不同的数据类型，指针变量也有不同的类型  

定义的一般形式  
```类型 *标识符;```  
标识符是 指针变量 的名称，指针变量的类型是"类型\*"  
例如  

```c
int *ip ;
float *fp ;
```

其中定义了两个指针变量 ip and fp ，其中 ip 的类型是 "int\*"， fp 的类型是 "float\*"  
指针变量可以存储对应类型的变量的地址  

```c
int i = 2 ;
ip = &i ;
```

上述代码段实现了将整形变量i的地址存入指针变量ip  
类似其他类型，指针变量定义时也可进行赋值初始化  

另外，由于局部变量的性质，未初始化很容易意想不到的奇怪情况，指针变量也是同理  
为明确表示指针变量不指向任何变量，用0(记为NULL)表示此情况，习惯上称此时的指针变量为 空指针  

*个人疑惑点：*既然认为指针变量类型为"类型\*"，为什么不直接让"\*"和"类型"紧贴？
*解释：*```int i , j , *p ;```语句是允许的！

对于初学者的易错点：  

1. 直接给指针变量赋整数值  
2. 为指针变量赋值时没有给对应变量加取地址符号\&  
3. 给指针变量赋不匹配的类型的变量的地址值 或者 将不同类型的指针变量相互赋值  

### 3. 引用指针变量所致的变量

上述段主要实现了 变量-\>地址-\>指针 的过程  
下文则开始讲 指针-\>地址-\>变量 的过程  

程序中引用变量方法：

1. 变量名  
2. 变量的地址  

例子  

```c
ip = &i ;
intpt = &j ;
*intpt = *ip + 5 ;
```

与代码

```c
j = i + 5 ;
```

效果等价  
其中"\*"就是间接引用运算符(也称解引用运算符)  
在printf中可以用"\%d"引用指针的值，就是其所存的地址值，以十六进制形式输出  
可见eg01.c的实例  

指针变量的最主要的应用：  

1. 指针指向数组元素，方便注意改变指针指向，以遍历数组  
2. 为函数设置指针形参，实现在函数住通过指针形参间接调用环境中的变量，实现 引用 or 改变  

注意点：  

1. 区分 定义指针变量 and 间接引用指针变量所指对象 时采用的 '\*'  
2. 通过变量名直接引用 与 通过指针间接引用 基本一致  
3. 然后是大家都最喜欢的 自增自减问题，随着指针的引入变得更加复杂！  
    找不同环节：  
    有定义```int i , j , *ip = &i;```  
    以下有三个运算  
    ```j = ++*ip ;```  
    ```j = *ip++ ;```  
    ```j = (*ip)++ ;```  
    第一个，等价于 先用ip取出i，再对i ++，再将i的值传给j  
    第二个，等价于 先用ip取出i，传入j，再让ip ++(常见于ip指向数组元素的情况，代表指向数组中的下一个元素)  
    第三个，等价于 先用ip去除i，传入j，再让i ++  
    评价是没事别瞎倒腾这些玩意  

## 6.2 指向数组元素的指针

### 1. 数组名 and 指针变量

首先有以下实例定义  
```int a[ 100 ] , *p ;```  
C语言规定，一维数组名表达式是数组首元素的指针  
也就是说```p = &a[ 0 ]```等价于```p = a```，都是使p指向a数组的首个元素a[ 0 ]  

C语言还定义了指向数组元素的指针的运算：  
*以下以实例说明*  

```c
int *p , *q , a[ 100 ] ;
p = &a[ 10 ] ;
q = &a[ 50 ] ;
```

在上述基础下可进行以下计算：  

1. 两个指向同一个数组的元素的指针可以进行比较运算  
    如上进行```p<q```的运算，结果为真  
2. 指向数组元素的指针可以与 整数 进行 加减 运算，实现指针在数组元素之间的移动  
    例如```p ++```可使`p`指向`a[ 11 ]`  

    注意点：C语言规定，指针变量指向数组`a[]`的元素时，不论数组元素类型，指针加减k的运算所对应的`p`的具体变化的字节数为 k乘以`size of a[0]` ，保证移动的对应的 **元素个数** 为k个  

    此外的应用：  与间接引用符号'\*'搭配使用  
    例如```*(p + i)```就表示元素```a[ 10 + i ]```，```*(a + i)```就表示```a[ i ]```  
    并且，上述前者可写成```p[ i ]```  
3. 当两个指针指向同一个数组的某两个元素时，允许两个指针做 减法 运算，结果绝对值等于两个指针所指数组元素之间相差的元素个数  
    上述例子```q-p```的值为40  

### 2. 引用数组元素的方法

引用数组元素方法的总结，3种：  

1. 数组名\[下标\]  
2. *(一维数组名表达式 + i )  
3. 利用指向数组元素的指针变量 搭配上述1or2  

注意点：指向数组首元素的指针变量 and 数组名 的异同  
同：存储的地址都是数组首元素的地址  
异：指针变量可以通过上述提及的运算2进行移动 but 数组名只能指向数组首字母，相当于常量  

指针在字符串中的应用  
因为字符串是存储在字符数组之中的，且其拥有一个性质就是在末尾有字符串结束符，故可以不用指定长度  
由上引出存储字符串常量的两种方式：

1. 存放在字符数组之中  
    ```char s[] = "I am a string."```  
    *注意：除了能算出来的14个字符以外，还有字符串末尾必带的'\\0'，故上述数组大小为15个元素*  
2. 存放字符串的第一个字符的地址于指针变量中  

    ```c
    char *cp1 , *cp2 = "I am a string." ;
    *cp1 = "Another string";
    ```

    上述第一行中 用字符串常量初始化字符指针变量  
    第二行中 用字符串常量赋值给字符指针变量  
    注意：字符串常量 存放在程序运行环境的 常量存储区 中  
    而赋值给字符指针变量的是该 字符常量 的 第一个字符的地址  
    此处不允许通过指针修改常量区的字符串常量  
    输出可以配合printf()函数 搭配 "\%s" ，对应 字符串的首地址，就可以实现输出整个字符串  

## 6.3 指针形参

C语言中，函数调用，会先为形参分配空间，再将实参的值传入函数，以初始化形参，此时修改形参不会改变实参  
此时 指针形参 则可以实现这种效果  
C语言规定，可以在函数形参表中，定义各种类型的指针变量  
例如```void divNum ( int *intPt , int d ) ;```  
以上函数声明中```intPt```就是一个指针形参，可以指向int类型的变量  
这样，通过将指向某变量的指针实参传入函数，函数就可以通过该指针类型形参调用环境中的变量  

简单来说，要实现函数能按需要改变有实参指定的变量时  
需要：  

1. 函数设置指针形参  
2. 函数体通过指针形参间接引用变量  
3. 调用函数是，以希望改变的变量的指针(或者说它的地址)为实参  

## 6.4 数组形参

为使函数可以处理不同的数组，函数可以设置 **数组形参**  
对应实参是数组某元素的地址，一般来说是首元素(且由于数组名可代表数组首元素的地址，常直接用数组名填充实参)  

### 1. 一维数组形参设置的一般形式

实例
```int sum ( int a[] , int n )```  
即指定数组的变量类型，不用指定元素的个数(因为实际上传入的就是一个常量指针变量，且没有要求一定是数组首元素)  
而元素的个数一般会在形参中另外设置一个整形形参用以代表数组的大小(或者是实际用到的数组范围)  
另外值得一提的是，虽然形参形式上是个数组，但是其本质上并不相同，此处它是可以改变的(与一般的数组名等同于常量指针形成差异)*  

调用：  

```c
int x[] = { 1 , 2 , 3 , 4, 5 } ;
int i , j ;
i = sum( x , 5 ) ;
j = sum( &x[ 2 ] , 3 ) ;
```

以上对应上述函数(定义省略)的调用，
直观来说，调用了整个x数组为i赋值，调用了一部分的x数组为j赋值  

### 2. 二维数组形参设置形式

最高维数可以和定义一维数组一样省略个数，但是**第一维必须指定个数**！  
(可以结合数组的存储方式来理解，多维数组顺序存储线性表，若不指定除最高维以外的大小，下标调用的方式就无从知道对应元素的具体地址)  

数组形参 and 指针形参 的关系：  
数组形参 实际上就是一种 指针形参 ，  
但是其指定了实参必须是 数组某元素 的指针，而不能是一般的变量  

## 6.5 指向二维数组一整行的指针

程序可以定义指向 二维数组一整行 的指针变量  
与指向数组某元素的指针的差别在于，这种指针增减一个单位，会向前或向后移动一整行  

1. 定义形式：  
    ```int (*p)[ 10 ] ;```  
    就实现了 指向一个由10个int型元素 组成的 数组  
    注意："()"是必须添加的(否则就变成了6.6中的指针数组)  

2. 应用方式：  
    以下结合实例进行说明  
    实例：  

    ```c
    int a[ 3 ][ 4 ] = { {1,2,3,4} , {5,6,7,8} , {9,10,11,12} } ;
    int (*p)[ 4 ] ;
    p = a ;
    ```

    以上代码段就实现了定义一个 $3\times4$ 的int型二维数组a，  
    以及一个指向 由4个int型元素 组成的数组的 指针p，  
    并且，将a第一行的一维数组a\[ 0 \]的首地址赋值给了p  

    **注意：**虽然类似于一维数组的，也有```a , a+i , a[ i ]```的表示但意义上有点不同  
    ```*(a + i)```是等价于```a[ i ]```的，也就是说```a + i```是指向```a```数组中第i行( $0\le i \le n-1$ )的一维数组的指针，对其解引用之后得到的是指向 这个一维数组的首元素 的指针 *(可以理解为一维数组的数组名)*  
    在这种背景下，指向 二维数组一整行的指针 的定位与上述中的```a + i```是类似的  

    具体结合上述例子来说就是：  
    ```a[ i ][ j ]```可以等价于  

   1) ```*(a[ i ] + j)```or```*(p[ i ] + j)```  
   2) ```*(*(a + i) + j)```or```*(*(p + i) + j)```  
   3) ```(*(a + i))[ j ]```or```(*(p + i))[ j ]```  

## 6.6 指针数组

**指针数组** 就是一个数组元素类型为 某种指针类型 的数组  
与6.5中 指向二维数组一整行的指针 的差别在于：此处本质是 **数组**，而后者本质是 **指针**  

1. 定义形式：  
    ```类型说明符 *标识符[常量表达式] ;```  
    标识符 为变量名称  
    **理解：**此处结合顺序是，标识符 先与后面的方括号结合(表明其为数组)，在与前面字符'\*'结合，表明数组的元素类型是一种指针类型  
    例如```int *p[ 10 ] ;```声明了一个包含10个int类型的指针变量组成的指针数组  

2. 应用方式 and 作用：  
    主要目的是便于统一管理同类指针，例如实现对一组独立变量以数组形式做统一处理  

    ```c
    int a, b, c, d, e, f ;
    int *ap[] = { &a , &b , &c , &d , &e , &f } ;
    for ( int i = 0 ; i < 6 ; i ++ )
        printf("%d " , *ap[ k ] ) ;     /*其中 *ap[ i ] 可写成 **(ap + i) */
    ```

    例如可用于排序，可以选择 交换指针对应的变量的值 or 交换指针所指的位置  
    当需要排序或者操作的信息量比较大的时候(例如对 字符串 排序)，显然 交换指针所指的位置 更合理  
    这时候就可以用上 **指针数组**  
    实际使用举例：  
   1) 每个指针指向一个字符串的首字符的地址，简单交换 指针 的值就可以实现对不同 字符串 的排序 *(注：此处没有改变字符串的存储的地址)*  
   2) 结合 二维数组 ，或者将 不同的一维数组 通过 指针数组 连结起来实现类似二维数组的引用方式  

## 6,7 多级指针

当pp所指的变量ip也是一种指针时，称pp是一种指向指针的指针，即一种多级指针  

1. 定义形式：  
    ```类型 **标识符```  
    标识符，变量名称  
    '\*'自右向左结合，故可以理解为先`*标识符`标识符命名一个指针变量，再有`**标识符`表示该指针变量可以指向某种指针类型的变量  

2. 应用方式：  
    由实例引入  

    ```c
    int **pp , *ip , i ;
    ip = &i ;
    pp = &ip ;
    ```

    就实现了：定义一个整型变量`i`，以及一个指向`i`的指针变量`p`，再定义了指向指针变量`ip`的指针变量`pp`  

    多级指针 与 指针数组 有着密切的联系  
    指针数组的 标识符 本身就是一个指针，其指向的 每个元素 也是一个指针  
    故指针数组名本身就是多级指针  

    然后很容易理解的，解引用二级指针可以得到一级指针，再次解引用才得到指向的变量的值  

## 6.8 函数指针

0. 引入：  
    为函数设置函数形参，可使函数被调用时，进一步需要调用的函数可以用实参指定  
    例如，二分法求连续实函数实根的函数(biRoot())  
    调用biRoot()时，需要指定一个要求根的函数  

    C语言为实现此类需求，引入了：  
    函数指针 and 函数指针类型 and 函数指针变量 and 利用函数指针调用所指函数 and 函数指针形参 等等概念  
    函数可以利用 实参提供的函数指针 调用 实参函数指针 所指向的函数  

1. 函数指针  
    程序载入内存时，对应 函数的执行代码 有一个 **入口地址**  
    调用此函数就会从此 入口地址 开始执行  
    C语言中，入口地址 被抽象为 **函数指针**，并使用 **函数名** 进行标识  
    也就是说：  
    函数指针就是一个函数的入口地址，，并且函数指针也可以 复制 and 存储  
2. 函数指针类型  
    函数返回值类型 and 函数形参顺序 and 形参类型 被抽象为 **函数指针类型**  

    定义函数指针类型可用 类型定义命名  
    一般形式为：  
    ```typedef 类型(*标识符)(形参类型表) ;```

    实例：  
    ```typedef int(*intPtType)(int * , int ) ;```
    就应以了一种 函数指针类型  
    代表 **一类** 函数：两个形参，第1个类型为`int*`，第二个为`int`，且函数返回`int`类型值  
3. 函数指针变量  
    **函数指针变量** 是存储函数指针值的 **变量**  
    可以作为 结构化数据的成分 or 调用函数的实参  
    当存储某个函数的指针时，就称此函数指针指向这个函数  
    程序此时就可以用此 函数指针变量 间接调用其所指函数  

    函数指针变量的**类型** 由函数指针类型描述，用于判断指向某个函数的合理性  
    函数指针变量只能指向类型要求一致的函数  

    定义的两种方法：  

   1) 由已经存在的函数指针类型定义  
        例如  
        ```sumPtType sumPt ;```  
   2) 直接指定函数指针变量的类型特性  
        一般形式：  
        ```类型 (*标识符)(形参类型表) ;```  

        过程理解：  
        此处标识符直接做变量的名称  
        首先，括号使该表支付与'\*'结合，说明定义为一种指针变量  
        再而，与后面的圆括号结合，说明这种指针变量可指向一种函数  
        前面的类型指明这种函数的返回值类型  
        例如  
        ```int (*fp)(int , double) ;```  

        注意：此处一般形式中的`(*标识符)`的"()"一定不可以省略，否则结合顺序就会变成对一个相应类型的返回值类型为`类型*`的指针的函数的声明  
        注意:在如今编译器的标准下,解引用这一步是可以省去的  

        赋值方式：  
        两个原则：同等类型 and (被传值函数)前有声明  
        即只有符合此函数指针变量的类型的函数可以将其函数指针赋值给此指针变量  
        且在赋值之前至少有对这个函数的声明  
4. 利用函数指针调用函数  
    首先先看一般函数的调用形式：  
    ```函数名(实参表)```  

    改用指向函数的指针变量间接调用函数，则写成：  
    ```(*函数指针变量名) (实参表)```  

    不难理解，其实和一般的指针是差不多的  
    **注意**：解引用时记得带括号  
    补充：直接使用指针等同于函数名来使用，在早期的C语言系统中报错，现代许多C++系统则允许这种写法  
5. 函数指针作为函数的形参  
    函数要设置函数指针形参，只需指明形参为函数指针类型即可  
    实例：  
    ```double afun( double a[] , int n , double(*fpt)(double * , int) )```  
    上述`afun`函数的形参列表中第三个即一种函数指针形参  
6. 函数指针数组  
    当有许多函数有相同的 返回值类型 and 形参设置 时，且程序需要可随机调用其中某函数，可将这些函数的指针存放在一个数组中，这种数组即 **函数指针数组** ，又称 **函数入口表**  
    例如：  
    ```double(*fpt[])(double* , int) = { max , min , ave } ;```  
    就将eg.16中的三个函数的指针都集成到了一个函数指针数组`fpt[]`中  

    作用：  
    编写程序时，函数指针数组作用很大  
    它可使程序的抽象层次更高，便于编写非常通用的程序  
    例如交互系统的界面设计中，可以使用函数指针数组来简化  

## 6.9 返回指针值的函数

函数可以返回指针值，其可以为 变量 or 某函数 的指针  

1. 返回变量的指针的函数  
    声明的一般形式：  
    ```类型 *标识符(形参类型表) ;```  
    类型为某种数据类型  
    标识符为函数名  
    结合顺序而言"()"高于'\*'，故标识符先与右侧形参类型表结合，表明其为函数名；之后再函数名之前的'\*'则表明此函数返回指针类型的值  
2. 返回函数指针的函数  
    声明的一般形式：  
    ```类型 (*标识符(形参类型表))(形参类型表) ;```  
    这个理解起来比较麻烦，结合过程：  

   1) 标识符与后面的圆括号结合，表明为函数名，并且给出形参顺序与类型  
   2) 随后与函数名前的'\*'结合，说明函数返回指针类型的值  
   3) 在于最后方的原括号结合，说明返回的指针为函数指针  
   4) 最后与最前方的类型结合，完整说明返回的函数指针类型  

## 6.10 引用

C语言非指针类型形参实际就是函数的局部变量，实参向函数传入值后，函数就无法再对实参变量进行操作了；指针类型形参则是通过传入某变量的地址到函数内的指针变量，函数借助此指针可以实现间接访问环境中的变量  

C++语言在C语言的基础上，增设了一种更简洁的形参类别——引用类别形参  
调用时，引用类型形参成为对应实参的引用，将函数对形参的访问直接对等为对实参变量的访问  

1. 引用的基本概念  
    已经了解的两种标志对象的方法：对象的名称直接 or 指向对象的指针间接 标志对象  
    此处介绍的 **引用** ，也是一种标志对象的方法  

    引用是一种 类型 ，但不是 值！  
    一个引用只能用于标识另一个对象，  
    因此严格来说，引用可以看作一种映射，把一个标识符映射到一个对象上，是我们可以通过访问这个标识符而等同于访问了这个对象  
    直观上来看，引用就是用一个标识符给一个对象起了一个别名  

    引用一般形式：  
    ```类型 &标识符(左值表达式)``` 或 ```类型 &标识符 = 左值表达式```  
    例子：设变量`x`为类型为`T`，想要用`r`引用`x`，声明为：  
    ```T &r = x ;```  

    注意：一个引用在初始化之后就不可以改变，其总是引用其再初始化时所指定的对象  

    同时要理解，引用与指针存在很大的不同  
    指针本身就是一种变量，而引用相当于是构建了一个映射  
    注意：因而建立引用时必须要进行初始化，且不会再映射到其他变量，直至其不再有效为止  
2. 引用的对象  
    `类型 &`声明的引用必须用`类型`的变量初始化  

    注意点：  
   1) 指针作为一种变量类型也是可以被引用的  
   2) 不能有常数和void类型的引用，因为实际上并没有void类型的变量  
   3) 数组的元素可以被引用，但是数组不能被引用  
   4) C++规定，不能给引用定义引用，不可以定义指向引用的指针(通过引用定义的指针实际上指向引用所映射的变量的地址)  
   5) 语法上允许为空指针(NULL)创建引用，但是，这有什么意义呢？  

3. 引用形参  
    C++中引入引用的主要目的就是为函数设置引用形参  
    使得实参实际上以形参的形式出现在函数之中，可读可写  
4. 用常量作为引用形参的实参  
    引入实例解释：  

    ```cpp
    #include <stdio.h>
    int h( const int &r )
    {
        return r;
    }
    int main()
    {
        printf("%d\n" , h(4) ) ;
        return 0;
    }
    ```

    以上源程序代码的函数`h`的形参`const int &r`就是相关的实现  
    用处：  
   1) 引用要标志的对象类型与其基类型不相同(但是编译程序指导如何将标志的对象的类型转换为引用的基类型)  
   2) 引用要标志一个常对象，程序在运行时建立一个类型为引用的基类型的匿名对象  

    注意：此时的const是必须的，否则会报错的！  
5. 返回引用的函数  
    函数返回值的时候，系统需要生成一个值的副本  
    而函数的返回值也可以是引用，但返回引用时，不生成引用的副本  

    作用：使函数调用可以写在赋值表达式等好的左边  

    注意：不可以返回函数内的自动变量的引用，因为当函数返回时，自动变量已经不存在了！  
